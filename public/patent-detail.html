<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹è¨±è©³ç´° - ãƒ†ãƒƒã‚¯ãƒãƒƒãƒ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .detail-container {
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .detail-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .detail-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            color: #7f8c8d;
        }
        
        .detail-section {
            margin-bottom: 2rem;
        }
        
        .detail-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .detail-info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .detail-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .interest-form {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .interest-form h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .interest-form textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
            min-height: 120px;
            margin-bottom: 1rem;
        }
        
        .price-tag {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .back-btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: #95a5a6;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 1rem;
        }
        
        .back-btn:hover {
            background-color: #7f8c8d;
        }
    </style>
    <link rel="stylesheet" href="stylish-common.css">
</head>
<body>
    <div class="bg-decoration"></div>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">TechMatch</a>
                <nav class="nav">
                    <a href="index.html" class="nav-link">ç‰¹è¨±ä¸€è¦§</a>
                    <a href="column.html" class="nav-link">æŠ€è¡“ã‚³ãƒ©ãƒ </a>
                    <a href="interview.html" class="nav-link">ç ”ç©¶è€…ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</a>
                    <a href="auth.html" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <a href="index.html" class="back-btn">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
            
            <div class="detail-container" id="patentDetail">
                <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2026 ãƒ†ãƒƒã‚¯ãƒãƒƒãƒ All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        let currentUser = null;
        
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('authLink').textContent = 'ãƒã‚¤ãƒšãƒ¼ã‚¸';
                    document.getElementById('authLink').href = 'mypage.html';
                }
            } catch (error) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„çŠ¶æ…‹
            }
        }
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹è¨±IDã‚’å–å¾—
        function getPatentId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        // ç‰¹è¨±è©³ç´°ã‚’èª­ã¿è¾¼ã¿
        async function loadPatentDetail() {
            const patentId = getPatentId();
            
            if (!patentId) {
                document.getElementById('patentDetail').innerHTML = '<p style="text-align: center; color: #e74c3c;">ç‰¹è¨±IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }
            
            try {
                const response = await fetch(`/api/patents/${patentId}`);
                
                if (!response.ok) {
                    document.getElementById('patentDetail').innerHTML = '<p style="text-align: center; color: #e74c3c;">ç‰¹è¨±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }
                
                const patent = await response.json();
                displayPatentDetail(patent);
            } catch (error) {
                document.getElementById('patentDetail').innerHTML = '<p style="text-align: center; color: #e74c3c;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
            }
        }
        
        // ç‰¹è¨±è©³ç´°ã‚’è¡¨ç¤º
        function displayPatentDetail(patent) {
            const categoryNames = {
                ai: 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’',
                iot: 'IoT',
                medical: 'åŒ»ç™‚æ©Ÿå™¨',
                manufacturing: 'è£½é€ æŠ€è¡“',
                energy: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼'
            };
            
            const statusNames = {
                available: 'åˆ©ç”¨å¯èƒ½',
                negotiation: 'äº¤æ¸‰ä¸­'
            };
            
            const container = document.getElementById('patentDetail');
            
            let interestFormHTML = '';
            if (currentUser && currentUser.id !== patent.ownerId) {
                interestFormHTML = `
                    <div class="interest-form">
                        <h3>ã“ã®ç‰¹è¨±ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã‹?</h3>
                        <p style="color: #7f8c8d; margin-bottom: 1rem;">èˆˆå‘³è¡¨æ˜ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ç‰¹è¨±ã®å‡ºé¡˜è€…ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚</p>
                        <form id="interestForm">
                            <textarea id="interestMessage" placeholder="èˆˆå‘³ã‚’æŒã£ãŸç†ç”±ã‚„ã”è³ªå•ãªã©ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..." required></textarea>
                            <button type="submit" class="action-btn">èˆˆå‘³ã‚’è¡¨æ˜ã™ã‚‹</button>
                        </form>
                    </div>
                `;
            } else if (!currentUser) {
                interestFormHTML = `
                    <div class="interest-form">
                        <h3>ã“ã®ç‰¹è¨±ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã‹?</h3>
                        <p style="color: #7f8c8d; margin-bottom: 1rem;">èˆˆå‘³è¡¨æ˜ã‚’è¡Œã†ã«ã¯<a href="auth.html" style="color: #3498db;">ãƒ­ã‚°ã‚¤ãƒ³</a>ãŒå¿…è¦ã§ã™ã€‚</p>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="detail-header">
                    <h1 class="detail-title">${patent.title}</h1>
                    <div class="detail-meta">
                        <span class="card-category">${categoryNames[patent.category]}</span>
                        <span class="card-status ${patent.status}">${statusNames[patent.status]}</span>
                        <span>${new Date(patent.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>ç‰¹è¨±æƒ…å ±</h3>
                    <div class="detail-info-grid">
                        <div class="detail-label">ç‰¹è¨±ç•ªå·:</div>
                        <div>${patent.patentNumber}</div>
                        
                        <div class="detail-label">å‡ºé¡˜è€…:</div>
                        <div>${patent.ownerName}</div>
                        
                        <div class="detail-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼:</div>
                        <div>${categoryNames[patent.category]}</div>
                    </div>
                    
                    <div class="price-tag">
                        å¸Œæœ›ä¾¡æ ¼: Â¥${patent.price.toLocaleString()}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>ç‰¹è¨±ã®èª¬æ˜</h3>
                    <p style="line-height: 1.8; color: #2c3e50;">${patent.description}</p>
                </div>
                
                ${patent.problem ? `
                <div class="detail-section">
                    <h3>ğŸ¯ è§£æ±ºã§ãã‚‹èª²é¡Œ</h3>
                    <p style="line-height: 1.8; color: #2c3e50;">${patent.problem}</p>
                </div>
                ` : ''}
                
                ${patent.usage ? `
                <div class="detail-section">
                    <h3>ğŸ’¡ ä½•ã«ã©ã†ä½¿ãˆã‚‹ã‹</h3>
                    <p style="line-height: 1.8; color: #2c3e50;">${patent.usage}</p>
                </div>
                ` : ''}
                
                ${patent.advantage ? `
                <div class="detail-section">
                    <h3>â­ ä»–ã®ç‰¹è¨±ã¨ã®é•ã„</h3>
                    <p style="line-height: 1.8; color: #2c3e50;">${patent.advantage}</p>
                </div>
                ` : ''}
                
                ${interestFormHTML}
            `;
            
            // èˆˆå‘³è¡¨æ˜ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (currentUser && currentUser.id !== patent.ownerId) {
                document.getElementById('interestForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await submitInterest(patent.id);
                });
            }
        }
        
        // èˆˆå‘³è¡¨æ˜ã‚’é€ä¿¡
        async function submitInterest(patentId) {
            const message = document.getElementById('interestMessage').value;
            
            try {
                const response = await fetch('/api/interests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patentId, message })
                });
                
                if (response.ok) {
                    alert('èˆˆå‘³ã‚’è¡¨æ˜ã—ã¾ã—ãŸï¼å‡ºé¡˜è€…ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚');
                    document.getElementById('interestMessage').value = '';
                } else {
                    const data = await response.json();
                    alert(data.error || 'èˆˆå‘³è¡¨æ˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            await loadPatentDetail();
        });
    </script>
    <script src="check-auth.js"></script>
</body>
</html>
